kind create cluster --config kind_example.yaml 

docker build -t my-static-nginx:latest .

kind load docker-image my-static-nginx:latest --name kind

kubectl config get-contexts

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts


kubectl create namespace monitoring

helm install prometheus-stack prometheus-community/kube-prometheus-stack --namespace monitoring

kubectl get crd servicemonitors.monitoring.coreos.com

kubectl get pods,svc,deployment,servicemonitor -o wide


kubectl port-forward service/my-static-site-my-static-site 8080:80


pip -m  venv venv

source venv/bin/activate

locust


docker build -t my-static-nginx:5rps-burst .
kind load docker-image my-static-nginx:5rps-burst
kubectl set image deployment/my-static-site-my-static-site nginx=my-static-nginx:5rps-burst



просмотр подов мониторинга
kubectl get pods -n monitoring 

kubectl port-forward -n monitoring service/prometheus-stack-grafana 3000:80


helm upgrade my-static-site  my-nginx/

для наблюдения под нагрузкой
watch -n 5 'kubectl get pods,hpa'

kubectl port-forward -n monitoring service/prometheus-stack-grafana 3000:80
locust -f scaling_test.py --host=http://localhost:31693 -u 25 -r 5


kubectl get secret -n monitoring prometheus-stack-grafana -o jsonpath="{.data.admin-password}" | base64 --decode && echo


https://github.com/nginx/nginx-prometheus-exporter


# Добавим репозиторий
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Установим Prometheus Adapter
helm install prometheus-adapter prometheus-community/prometheus-adapter \
  --namespace monitoring \
  --create-namespace \
  --set prometheus.url=http://kube-prometheus-stack-prometheus.monitoring.svc \
  --set prometheus.port=9090


  # Используем правильное имя образа (nginx/, а не nginxinc/)
docker pull nginx/nginx-prometheus-exporter:1.3.0

# Загружаем образ в kind
kind load docker-image nginx/nginx-prometheus-exporter:1.3.0 --name kind


victor@keler:~/Desktop/kind-example/test_work$ kubectl patch hpa my-static-site-my-static-site --type='merge' -p='
{
  "spec": {
    "metrics": [
      {
        "type": "Pods",
        "pods": {
          "metric": {
            "name": "nginx_http_requests"
          },
          "target": {
            "type": "AverageValue", 
            "averageValue": "5"
          }
        }
      }
    ]
  }
}'




(   for i in {1..3600}; do  # 20 RPS на 3 минуты
    curl -s http://localhost:8080/ >/dev/null &     sleep 0.05  # 20 запросов в секунду
    if [ $((i % 200)) -eq 0 ]; then       HPA_VALUE=$(kubectl get hpa keda-hpa-nginx-simple-scaler --no-headers | awk '{print $4}');       PODS=$(kubectl get pods -l app=my-static-site --no-headers | wc -l);       echo "Секунда $((i/20)): HPA = $HPA_VALUE, Подов = $PODS";     fi;   done; )



helm upgrade ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --set controller.service.type=NodePort \
  --set controller.service.nodePorts.http=30806 \
  --set controller.service.nodePorts.https=30807 \
  --set controller.metrics.enabled=true \
  --set controller.metrics.serviceMonitor.enabled=true \
  --set controller.metrics.serviceMonitor.additionalLabels.release="prometheus-stack"


  kind create cluster --name test-cluster --config=kind-rps-cluster.yaml

  kubectl config use-context kind-test-cluster

  docker build -t my-static-nginx:latest .
  kind load docker-image my-static-nginx:latest --name test-cluster

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx  
helm repo add kedacore https://kedacore.github.io/charts
helm repo update


# Prometheus + Grafana
helm install prometheus-stack prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace \
  --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false


  helm install keda kedacore/keda \
  --namespace keda-system \
  --create-namespace


  helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace \
  --set controller.service.type=NodePort \
  --set controller.service.nodePorts.http=30080 \
  --set controller.metrics.enabled=true \
  --set controller.metrics.serviceMonitor.enabled=true \
  --set controller.metrics.serviceMonitor.additionalLabels.release="prometheus-stack"




  helm install  my-static-site  my-nginx/
  kubectl apply -f my-nginx/keda-nginx-simple.yaml 
  kubectl apply -f my-nginx/nginx-ingress-fixed.yaml


  kubectl port-forward service/prometheus-stack-kube-prom-prometheus 9090:9090 -n monitoring


  helm install prometheus-adapter prometheus-community/prometheus-adapter \
  --namespace prometheus \
  --values prometheus-adapter-values.yaml

